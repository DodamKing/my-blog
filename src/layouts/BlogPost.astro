---
import { Image } from "astro:assets";
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import FormattedDate from "../components/FormattedDate.astro";
import Header from "../components/Header.astro";
import AdSense from "../components/AdSense.astro"
import RelatedPosts from "../components/RelatedPosts.astro";
import PostNavigation from "../components/PostNavigation.astro";

type Props = CollectionEntry<"blog">["data"];

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  lang = "ko",
} = Astro.props;

// 읽는 시간 계산 (대략 분당 200단어 기준)
const content = await Astro.slots.render("default");
const wordCount = content.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);
---

<html lang={lang}>
  <head>
    <BaseHead title={title} description={description} />
  </head>

  <body>
    <Header />
    <main>
      <article>
        {
          heroImage && (
            <div class="hero-image">
              <div class="hero-image-wrapper">
                <Image
                  width={1400}
                  height={700}
                  src={heroImage}
                  alt={title}
                  quality={85}
                />
              </div>
            </div>
          )
        }

        <div class="article-container">
          <header class="article-header">
            <div class="article-meta">
              <time class="date">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path
                    d="M13 2H12V1C12 0.734784 11.8946 0.48043 11.7071 0.292893C11.5196 0.105357 11.2652 0 11 0C10.7348 0 10.4804 0.105357 10.2929 0.292893C10.1054 0.48043 10 0.734784 10 1V2H6V1C6 0.734784 5.89464 0.48043 5.70711 0.292893C5.51957 0.105357 5.26522 0 5 0C4.73478 0 4.48043 0.105357 4.29289 0.292893C4.10536 0.48043 4 0.734784 4 1V2H3C2.20435 2 1.44129 2.31607 0.87868 2.87868C0.316071 3.44129 0 4.20435 0 5V13C0 13.7956 0.316071 14.5587 0.87868 15.1213C1.44129 15.6839 2.20435 16 3 16H13C13.7956 16 14.5587 15.6839 15.1213 15.1213C15.6839 14.5587 16 13.7956 16 13V5C16 4.20435 15.6839 3.44129 15.1213 2.87868C14.5587 2.31607 13.7956 2 13 2ZM14 13C14 13.2652 13.8946 13.5196 13.7071 13.7071C13.5196 13.8946 13.2652 14 13 14H3C2.73478 14 2.48043 13.8946 2.29289 13.7071C2.10536 13.5196 2 13.2652 2 13V8H14V13Z"
                    fill="currentColor"></path>
                </svg>
                <FormattedDate date={pubDate} lang={lang} />
              </time>
              <span class="separator">·</span>
              <span class="reading-time">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  <path
                    d="M8 0C3.58 0 0 3.58 0 8C0 12.42 3.58 16 8 16C12.42 16 16 12.42 16 8C16 3.58 12.42 0 8 0ZM8 14C4.69 14 2 11.31 2 8C2 4.69 4.69 2 8 2C11.31 2 14 4.69 14 8C14 11.31 11.31 14 8 14Z"
                    fill="currentColor"></path>
                  <path
                    d="M8.5 4H7V9L11.25 11.52L12 10.25L8.5 8.15V4Z"
                    fill="currentColor"></path>
                </svg>
                {readingTime}
                {lang === "ko" ? "분 소요" : "min read"}
              </span>
            </div>

            <h1 class="title">{title}</h1>

            {description && <p class="description">{description}</p>}

            {
              updatedDate && (
                <div class="updated-notice">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path
                      d="M8 16C3.58172 16 0 12.4183 0 8C0 3.58172 3.58172 0 8 0C12.4183 0 16 3.58172 16 8C16 12.4183 12.4183 16 8 16ZM8 2C4.68629 2 2 4.68629 2 8C2 11.3137 4.68629 14 8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2Z"
                      fill="currentColor"
                    />
                    <path
                      d="M11.7071 6.70711L7.5 10.9142L4.79289 8.20711L6.20711 6.79289L7.5 8.08579L10.2929 5.29289L11.7071 6.70711Z"
                      fill="currentColor"
                    />
                  </svg>
                  {lang === 'ko' ? '업데이트' : 'Updated on'} <FormattedDate date={updatedDate} lang={lang} />
                </div>
              )
            }

            <div class="divider"></div>
          </header>

		  <!-- 첫 번째 광고: 본문 시작 전 -->
          <AdSense />

          <div class="prose">
            <slot />
          </div>

		  <!-- 마지막 광고: 본문 끝 -->
          <AdSense />

          <footer class="article-footer">
            <div class="share-section">
              <p class="share-text">
                {lang === 'ko' ? '이 글이 도움이 되셨나요? 공유해보세요!' : 'Found this helpful? Share it!'}
              </p>
              <div class="share-buttons">
                <button class="share-button twitter" id="share-twitter-btn">
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      d="M23 3a10.9 10.9 0 01-3.14 1.53 4.48 4.48 0 00-7.86 3v1A10.66 10.66 0 013 4s-4 9 5 13a11.64 11.64 0 01-7 2c9 5 20 0 20-11.5a4.5 4.5 0 00-.08-.83A7.72 7.72 0 0023 3z"
                    ></path>
                  </svg>
                  Twitter
                </button>
                <button class="share-button facebook" id="share-facebook-btn">
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="currentColor"
                  >
                    <path
                      d="M18 2h-3a5 5 0 00-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 011-1h3z"
                    ></path>
                  </svg>
                  Facebook
                </button>
                <button class="share-button link" id="copy-link-btn">
                  <svg
                    width="20"
                    height="20"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                  >
                    <path
                      d="M10 13a5 5 0 007.54.54l3-3a5 5 0 00-7.07-7.07l-1.72 1.71"
                    ></path>
                    <path
                      d="M14 11a5 5 0 00-7.54-.54l-3 3a5 5 0 007.07 7.07l1.71-1.71"
                    ></path>
                  </svg>
                  {lang === 'ko' ? '링크 복사' : 'Copy Link'}
                </button>
              </div>
            </div>

            <!-- 이전/다음글 추가 -->
            <PostNavigation currentId={Astro.params.slug} lang={lang} />

            <!-- 다른 글 보기 -->
            <RelatedPosts lang={lang} />

            <a href="/" class="back-link">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M19 12H5M12 19l-7-7 7-7"></path>
              </svg>
              {lang === 'ko' ? '홈으로 돌아가기' : 'Back to Home'}
            </a>
          </footer>
        </div>
      </article>
    </main>
    <Footer />

    <script define:vars={{ lang }}>
      // Twitter 공유
      document
        .getElementById("share-twitter-btn")
        ?.addEventListener("click", function () {
          const url = window.location.href;
          const title = document.title;
          window.open(
            `https://twitter.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`,
            "_blank"
          );
        });

      // Facebook 공유
      document
        .getElementById("share-facebook-btn")
        ?.addEventListener("click", function () {
          const url = window.location.href;
          window.open(
            `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`,
            "_blank"
          );
        });

      // 링크 복사
      document
        .getElementById("copy-link-btn")
        ?.addEventListener("click", function (event) {
          const url = window.location.href;
          const button = event.currentTarget;

          const copiedText = lang === 'ko' ? '복사됨!' : 'Copied!';
          const failMessage = lang === 'ko' ? '복사 실패. 수동으로 복사해주세요.' : 'Failed to copy. Please copy manually.';

          navigator.clipboard
            .writeText(url)
            .then(() => {
              const originalHTML = button.innerHTML;
              button.innerHTML =
                `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> ${copiedText}`;

              setTimeout(() => {
                button.innerHTML = originalHTML;
              }, 2000);
            })
            .catch((err) => {
              console.error("Failed to copy:", err);
              alert(failMessage);
            });
        });

      // ========================================
      // 중간 광고 자동 삽입 (새로 추가된 부분)
      // ========================================
      window.addEventListener('DOMContentLoaded', () => {
        const prose = document.querySelector('.prose');
        if (!prose) return;

        const h2s = prose.querySelectorAll('h2');
        const totalH2s = h2s.length;

        // 글 길이에 따라 광고 개수 결정
        let adCount;
        if (totalH2s <= 4) {
          adCount = 0;  // 짧은 글: 중간 광고 없음 (시작/끝만)
        } else if (totalH2s <= 7) {
          adCount = 2;  // 중간 길이: 2개
        } else if (totalH2s <= 10) {
          adCount = 3;  // 긴 글: 3개
        } else {
          adCount = 4;  // 매우 긴 글: 4개
        }

        if (adCount === 0) return;

        // H2를 균등하게 나눠서 광고 위치 계산
        const positions = [];
        const interval = totalH2s / (adCount + 1);
        
        for (let i = 1; i <= adCount; i++) {
          const index = Math.floor(interval * i) - 1;
          if (index >= 0 && index < totalH2s) {
            positions.push(index);
          }
        }

        // 각 위치에 광고 삽입
        positions.forEach((index) => {
          const h2 = h2s[index];
          if (h2) {
            // 광고 컨테이너 생성
            const adContainer = document.createElement('div');
            adContainer.className = 'adsense-auto-insert';
            adContainer.style.margin = '3rem 0';
            adContainer.style.textAlign = 'center';
            
            // AdSense 광고 코드 (실제 사용 시 data-ad-client, data-ad-slot 수정 필요)
            adContainer.innerHTML = `
              <ins class="adsbygoogle"
                   style="display:block"
                   data-ad-format="auto"
                   data-full-width-responsive="true"></ins>
            `;

            // H2 다음 요소 앞에 삽입 (H2와 내용 사이)
            if (h2.nextElementSibling) {
              h2.parentNode.insertBefore(adContainer, h2.nextElementSibling);
            } else {
              h2.parentNode.appendChild(adContainer);
            }

            // AdSense 스크립트 실행
            if (window.adsbygoogle) {
              try {
                (window.adsbygoogle = window.adsbygoogle || []).push({});
              } catch (e) {
                console.error('AdSense error:', e);
              }
            }
          }
        });
      });
    </script>
  </body>
</html>

<style>
  :root {
    --content-width: 720px;
    --accent: #667eea;
    --accent-dark: #5a67d8;
  }

  body {
    background: #fafafa;
  }

  main {
    width: 100%;
    background: #ffffff;
  }

  article {
    max-width: 100%;
    margin: 0 auto;
  }

  .hero-image {
    width: 100%;
    max-width: 1400px;
    margin: 0 auto 3rem;
    padding: 0 2rem;
  }

  .hero-image-wrapper {
    width: 100%;
    max-height: 500px;
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
  }

  .hero-image img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .article-container {
    max-width: var(--content-width);
    margin: 0 auto;
    padding: 0 2rem 4rem;
  }

  .article-header {
    margin-bottom: 3rem;
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.9375rem;
    color: #6b7280;
    margin-bottom: 1.5rem;
  }

  .article-meta svg {
    width: 16px;
    height: 16px;
    margin-right: 0.375rem;
  }

  .date,
  .reading-time {
    display: flex;
    align-items: center;
  }

  .separator {
    color: #d1d5db;
  }

  .title {
    font-size: 2.75rem;
    font-weight: 900;
    line-height: 1.2;
    color: #1a1a1a;
    margin: 0 0 1rem 0;
    letter-spacing: -0.03em;
  }

  .description {
    font-size: 1.25rem;
    line-height: 1.6;
    color: #6b7280;
    margin: 0 0 1.5rem 0;
  }

  .updated-notice {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: #f0f9ff;
    border: 1px solid #bfdbfe;
    border-radius: 8px;
    font-size: 0.875rem;
    color: #1e40af;
    margin-bottom: 1.5rem;
  }

  .updated-notice svg {
    width: 16px;
    height: 16px;
    flex-shrink: 0;
  }

  .divider {
    width: 100%;
    height: 1px;
    background: linear-gradient(to right, transparent, #e5e7eb, transparent);
    margin: 2rem 0;
  }

  /* Prose styles */
  .prose {
    font-size: 1.125rem;
    line-height: 1.8;
    color: #374151;
  }

  .prose :global(h2) {
    font-size: 2rem;
    font-weight: 800;
    margin: 3rem 0 1.5rem;
    color: #1a1a1a;
    letter-spacing: -0.02em;
    position: relative;
    padding-bottom: 0.5rem;
  }

  .prose :global(h2::after) {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 60px;
    height: 4px;
    background: linear-gradient(90deg, var(--accent), var(--accent-dark));
    border-radius: 2px;
  }

  .prose :global(h3) {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 2.5rem 0 1rem;
    color: #1a1a1a;
  }

  .prose :global(p) {
    margin: 1.5rem 0;
  }

  .prose :global(a) {
    color: var(--accent);
    text-decoration: none;
    border-bottom: 2px solid transparent;
    transition: all 0.2s ease;
    font-weight: 500;
  }

  .prose :global(a:hover) {
    border-bottom-color: var(--accent);
  }

  .prose :global(strong) {
    font-weight: 700;
    color: #1a1a1a;
  }

  .prose :global(ul),
  .prose :global(ol) {
    margin: 1.5rem 0;
    padding-left: 2rem;
  }

  .prose :global(li) {
    margin: 0.75rem 0;
  }

  .prose :global(li::marker) {
    color: var(--accent);
  }

  .prose :global(blockquote) {
    margin: 2.5rem 0;
    padding: 1.5rem 2rem;
    border-left: 4px solid var(--accent);
    background: linear-gradient(
      to right,
      rgba(102, 126, 234, 0.05),
      transparent
    );
    font-style: italic;
    color: #4b5563;
    border-radius: 0 8px 8px 0;
  }

  .prose :global(code) {
    font-family: "Monaco", "Consolas", monospace;
    font-size: 0.9em;
    padding: 0.25em 0.5em;
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    color: #e83e8c;
  }

  .prose :global(pre) {
    margin: 2.5rem 0;
    padding: 1.5rem;
    background: #1e293b;
    border-radius: 12px;
    overflow-x: auto;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }

  .prose :global(pre code) {
    background: transparent;
    padding: 0;
    border: none;
    color: #e2e8f0;
    font-size: 0.9375rem;
  }

  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 12px;
    margin: 2.5rem 0;
    display: block;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  }

  .prose :global(hr) {
    margin: 3rem 0;
    border: none;
    height: 1px;
    background: linear-gradient(to right, transparent, #e5e7eb, transparent);
  }

  /* 테이블 스타일 추가 */
  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    font-size: 0.95rem;
    overflow-x: auto;
    display: block;
  }

  .prose :global(thead) {
    background: linear-gradient(135deg, var(--accent), var(--accent-dark));
  }

  .prose :global(th) {
    color: white;
    padding: 1rem;
    text-align: left;
    font-weight: 600;
    white-space: nowrap;
  }

  .prose :global(td) {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid #e5e7eb;
  }

  .prose :global(tbody tr:hover) {
    background: #f9fafb;
  }

  .prose :global(tbody tr:last-child td) {
    border-bottom: none;
  }

  /* Article Footer */
  .article-footer {
    margin-top: 4rem;
    padding-top: 3rem;
    border-top: 1px solid #e5e7eb;
  }

  .share-section {
    margin-bottom: 2rem;
  }

  .share-text {
    font-size: 1rem;
    font-weight: 600;
    color: #374151;
    margin-bottom: 1rem;
  }

  .share-buttons {
    display: flex;
    gap: 0.75rem;
    flex-wrap: wrap;
  }

  .share-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    background: #ffffff;
    color: #4b5563;
    font-size: 0.9375rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .share-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .share-button.twitter:hover {
    border-color: #1da1f2;
    color: #1da1f2;
    background: rgba(29, 161, 242, 0.05);
  }

  .share-button.facebook:hover {
    border-color: #4267b2;
    color: #4267b2;
    background: rgba(66, 103, 178, 0.05);
  }

  .share-button.link:hover {
    border-color: var(--accent);
    color: var(--accent);
    background: rgba(102, 126, 234, 0.05);
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(
      135deg,
      var(--accent) 0%,
      var(--accent-dark) 100%
    );
    color: #ffffff;
    text-decoration: none;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  .back-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .hero-image {
      padding: 0 1rem;
      margin-bottom: 2rem;
    }

    .article-container {
      padding: 0 1.5rem 3rem;
    }

    .title {
      font-size: 2rem;
    }

    .description {
      font-size: 1.125rem;
    }

    .prose {
      font-size: 1.0625rem;
    }

    .prose :global(h2) {
      font-size: 1.625rem;
      margin: 2.5rem 0 1rem;
    }

    .prose :global(h3) {
      font-size: 1.375rem;
    }

    .prose :global(table) {
      font-size: 0.875rem;
    }

    .prose :global(th),
    .prose :global(td) {
      padding: 0.625rem 0.75rem;
    }

    .share-buttons {
      flex-direction: column;
    }

    .share-button {
      width: 100%;
      justify-content: center;
    }
  }
</style>