---
import type { CollectionEntry } from "astro:content";
import BaseHead from "../components/BaseHead.astro";
import Footer from "../components/Footer.astro";
import Header from "../components/Header.astro";
import AdSense from "../components/AdSense.astro";
import RelatedPosts from "../components/RelatedPosts.astro";
import PostNavigation from "../components/PostNavigation.astro";
import HeroImage from "../components/HeroImage.astro";
import ArticleHeader from "../components/ArticleHeader.astro";
import ShareButtons from "../components/ShareButtons.astro";
import { ADSENSE_CONFIG } from "../consts";

type Props = CollectionEntry<"blog">["data"];

const {
  title,
  description,
  pubDate,
  updatedDate,
  heroImage,
  lang = "ko",
} = Astro.props;

const ogImage = heroImage?.src;

// 읽는 시간 계산
const content = await Astro.slots.render("default");
const wordCount = content.split(/\s+/).length;
const readingTime = Math.ceil(wordCount / 200);
---

<html lang={lang}>
  <head>
    <BaseHead title={title} description={description} image={ogImage} />
  </head>

  <body>
    <Header />
    <main>
      <article>
        <HeroImage heroImage={heroImage} title={title} />

        <div class="article-container">
          <ArticleHeader
            title={title}
            description={description}
            pubDate={pubDate}
            updatedDate={updatedDate}
            lang={lang}
            readingTime={readingTime}
          />

          <!-- 첫 번째 광고 -->
          <AdSense />

          <div class="prose">
            <slot />
          </div>

          <!-- 마지막 광고 -->
          <AdSense />

          <footer class="article-footer">
            <ShareButtons lang={lang} />
            <PostNavigation currentId={Astro.params.slug} lang={lang} />
            <RelatedPosts lang={lang} />

            <a href="/" class="back-link">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M19 12H5M12 19l-7-7 7-7"></path>
              </svg>
              {lang === "ko" ? "홈으로 돌아가기" : "Back to Home"}
            </a>
          </footer>
        </div>
      </article>
    </main>
    <Footer />

    <script define:vars={{ lang, adConfig: ADSENSE_CONFIG }}>
      function initAllAds() {
        const insList = document.querySelectorAll("ins.adsbygoogle");

        insList.forEach((ins) => {
          const status =
            ins.getAttribute("data-adsbygoogle-status") ||
            ins.getAttribute("data-ad-status");
          if (status) return;

          try {
            (window.adsbygoogle = window.adsbygoogle || []).push({});
          } catch (e) {
            console.error("AdSense init error:", e);
          }
        });
      }

      // 중간 광고 자동 삽입
      window.addEventListener("DOMContentLoaded", () => {
        const prose = document.querySelector(".prose");
        if (!prose) return;

        const h2s = prose.querySelectorAll("h2");
        const totalH2s = h2s.length;

        let adCount = 0;

        if (totalH2s <= 4) {
          adCount = 0;
        } else if (totalH2s <= 7) {
          adCount = 1;
        } else if (totalH2s <= 10) {
          adCount = 2;
        } else if (totalH2s <= 14) {
          adCount = 3;
        } else {
          adCount = 4;
        }

        if (adCount === 0) {
          initAllAds();
          return;
        }

        const positions = [];
        const interval = totalH2s / (adCount + 1);

        for (let i = 1; i <= adCount; i++) {
          const index = Math.floor(interval * i) - 1;
          if (index >= 0 && index < totalH2s) positions.push(index);
        }

        positions.forEach((index) => {
          const h2 = h2s[index];
          if (!h2) return;

          const adContainer = document.createElement("div");
          adContainer.className = "adsense-auto-insert";
          adContainer.style.margin = "3rem 0";
          adContainer.style.textAlign = "center";

          adContainer.innerHTML = `
            <ins class="adsbygoogle"
                 style="display:block"
                 data-ad-client="${adConfig.client}"
                 data-ad-slot="${adConfig.slot}"
                 data-ad-format="auto"
                 data-full-width-responsive="true"></ins>
          `;

          if (h2.nextElementSibling) {
            h2.parentNode.insertBefore(adContainer, h2.nextElementSibling);
          } else {
            h2.parentNode.appendChild(adContainer);
          }
        });

        initAllAds();
      });
    </script>
  </body>
</html>

<style>
  :root {
    --content-width: 720px;
    --accent: #667eea;
    --accent-dark: #5a67d8;
  }

  body {
    background: #fafafa;
  }

  main {
    width: 100%;
    background: #ffffff;
  }

  article {
    max-width: 100%;
    margin: 0 auto;
  }

  .article-container {
    max-width: var(--content-width);
    margin: 0 auto;
    padding: 0 2rem 4rem;
  }

  /* Prose styles */
  .prose {
    font-size: 1.125rem;
    line-height: 1.8;
    color: #374151;
  }

  .prose :global(h2) {
    font-size: 2rem;
    font-weight: 800;
    margin: 2.5rem 0 1.25rem;
    color: #1a1a1a;
    letter-spacing: -0.02em;
    position: relative;
    padding-left: 1.5rem;
  }

  .prose :global(h2::before) {
    content: "";
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 5px;
    background: linear-gradient(180deg, var(--accent), var(--accent-dark));
    border-radius: 3px;
  }

  .prose :global(h3) {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 2rem 0 1rem;
    color: #1a1a1a;
  }

  .prose :global(p) {
    margin: 1.5rem 0;
  }

  .prose :global(a) {
    color: var(--accent);
    text-decoration: none;
    position: relative;
    font-weight: 500;
    transition: color 0.2s ease;
  }

  .prose :global(a::after) {
    content: "";
    position: absolute;
    bottom: -2px;
    left: 0;
    width: 0;
    height: 2px;
    background: var(--accent);
    transition: width 0.3s ease;
  }

  .prose :global(a:hover) {
    color: var(--accent-dark);
  }

  .prose :global(a:hover::after) {
    width: 100%;
  }

  .prose :global(strong) {
    font-weight: 700;
    color: #1a1a1a;
    background: linear-gradient(
      180deg,
      transparent 60%,
      rgba(102, 126, 234, 0.2) 60%
    );
    padding: 0 0.2em;
  }

  .prose :global(ul) {
    list-style: none;
    margin: 1.5rem 0;
    padding-left: 1.5rem;
  }

  .prose :global(ul li) {
    position: relative;
    padding-left: 1.5rem;
    margin: 0.75rem 0;
  }

  .prose :global(ul li::before) {
    content: "→";
    position: absolute;
    left: 0;
    color: var(--accent);
    font-weight: bold;
  }

  .prose :global(ol) {
    margin: 1.5rem 0;
    padding-left: 2rem;
  }

  .prose :global(ol li) {
    margin: 0.75rem 0;
  }

  .prose :global(ol li::marker) {
    color: var(--accent);
    font-weight: bold;
  }

  .prose :global(blockquote) {
    margin: 2rem 0;
    padding: 1.5rem 1.5rem 1.5rem 3rem;
    border-left: 4px solid var(--accent);
    background: linear-gradient(
      135deg,
      rgba(102, 126, 234, 0.08),
      rgba(90, 103, 216, 0.05)
    );
    border-radius: 12px;
    position: relative;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
    font-style: italic;
    color: #4b5563;
  }

  .prose :global(blockquote::before) {
    content: '"';
    position: absolute;
    top: 1rem;
    left: 0.75rem;
    font-size: 3rem;
    color: rgba(102, 126, 234, 0.2);
    font-family: Georgia, serif;
    line-height: 1;
  }

  .prose :global(code) {
    font-family: "Monaco", "Consolas", monospace;
    font-size: 0.9em;
    padding: 0.25em 0.5em;
    background: #f3f4f6;
    border: 1px solid #e5e7eb;
    border-radius: 4px;
    color: #e83e8c;
  }

  .prose :global(pre) {
    margin: 2rem 0;
    padding: 2.5rem 1.5rem 1.5rem;
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    border-radius: 12px;
    border: 1px solid rgba(102, 126, 234, 0.2);
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
  }

  .prose :global(pre::before) {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 30px;
    background: rgba(102, 126, 234, 0.1);
    border-bottom: 1px solid rgba(102, 126, 234, 0.2);
  }

  .prose :global(pre code) {
    background: transparent;
    padding: 0;
    border: none;
    color: #e2e8f0;
    font-size: 0.9375rem;
  }

  .prose :global(img) {
    max-width: 100%;
    height: auto;
    border-radius: 12px;
    margin: 2.5rem 0;
    display: block;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  }

  .prose :global(hr) {
    margin: 3rem 0;
    border: none;
    height: 1px;
    background: linear-gradient(to right, transparent, #e5e7eb, transparent);
  }

  .prose :global(table) {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    font-size: 0.95rem;
    overflow-x: auto;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    table-layout: fixed;
  }

  .prose :global(thead) {
    background: linear-gradient(135deg, var(--accent), var(--accent-dark));
  }

  .prose :global(th) {
    color: white;
    padding: 1rem;
    text-align: center;
    font-weight: 600;
    white-space: normal;
    line-height: 1.2;
  }

  .prose :global(td) {
    padding: 0.875rem 1rem;
    border-bottom: 1px solid #e5e7eb;
    text-align: center;
  }

  .prose :global(td:first-child),
  .prose :global(th:first-child) {
    text-align: left;
  }

  .prose :global(tbody tr:hover) {
    background: #f9fafb;
  }

  .prose :global(tbody tr:last-child td) {
    border-bottom: none;
  }

  .article-footer {
    margin-top: 4rem;
    padding-top: 3rem;
    border-top: 1px solid #e5e7eb;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    background: linear-gradient(
      135deg,
      var(--accent) 0%,
      var(--accent-dark) 100%
    );
    color: #ffffff;
    text-decoration: none;
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.2s ease;
    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
  }

  .back-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }

  @media (max-width: 768px) {
    .article-container {
      padding: 0 1.5rem 3rem;
    }

    .prose {
      font-size: 1.0625rem;
    }

    .prose :global(h2) {
      font-size: 1.625rem;
      margin: 2rem 0 1rem;
      padding-left: 1.25rem;
    }

    .prose :global(h2::before) {
      width: 4px;
    }

    .prose :global(h3) {
      font-size: 1.375rem;
    }

    .prose :global(blockquote) {
      padding: 1.25rem 1.25rem 1.25rem 2.5rem;
    }

    .prose :global(blockquote::before) {
      font-size: 2.5rem;
      left: 0.5rem;
    }

    .prose :global(pre) {
      padding: 2.25rem 1rem 1rem;
    }

    /* 테이블 모바일 최적화 - 심플하게 */
    .prose :global(table) {
      font-size: 0.875rem;
      display: block;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      table-layout: fixed;
    }

    .prose :global(thead),
    .prose :global(tbody) {
      display: table-row-group;
      width: 100%;
    }

    .prose :global(tr) {
      display: table-row;
      width: 100%;
    }

    .prose :global(th),
    .prose :global(td) {
      display: table-cell;
      padding: 0.625rem 0.75rem;
      white-space: nowrap;
    }

    .prose :global(td:first-child),
    .prose :global(th:first-child) {
      white-space: normal;
      min-width: 100px;
    }
  }
</style>